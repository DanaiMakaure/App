<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ff0000">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš—</text></svg>">
    <title>AutoGuard - Automotive Collision Prevention</title>
    <style>
        /* ALL CSS STAYS THE SAME AS BEFORE - NO CHANGES NEEDED */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #ff0000;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 2.8rem;
            background: linear-gradient(45deg, #ff0000, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 20px rgba(255, 0, 0, 0.3);
        }

        .tagline {
            color: #aaa;
            font-size: 1.2rem;
            font-weight: 300;
        }

        .severity-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .severity-low {
            background: #27ae60;
        }

        .severity-medium {
            background: #f39c12;
        }

        .severity-high {
            background: #e74c3c;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Dashboard Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .camera-container {
            position: relative;
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            background: #000;
        }

        #camera {
            width: 100%;
            height: auto;
            display: block;
        }

        .detection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .hazard-zone {
            position: absolute;
            top: 60%;
            left: 10%;
            right: 10%;
            height: 30%;
            border: 3px dashed #ff0000;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 10px;
        }

        /* Status Panels */
        .status-panel {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #333;
        }

        .hazard-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .hazard-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #ff0000;
        }

        .hazard-item.safe {
            border-left-color: #27ae60;
        }

        .hazard-item.warning {
            border-left-color: #f39c12;
        }

        .hazard-item.danger {
            border-left-color: #e74c3c;
        }

        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
        }

        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #d35400);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #333;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .metric-danger {
            color: #e74c3c;
            animation: pulse 1.5s infinite;
        }

        .metric-warning {
            color: #f39c12;
        }

        .metric-safe {
            color: #27ae60;
        }

        /* Alerts */
        .emergency-alert {
            background: linear-gradient(45deg, #ff0000, #ff6b6b);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.3rem;
            display: none;
            animation: emergencyPulse 0.5s infinite;
        }

        @keyframes emergencyPulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }

        .vibrate {
            animation: vibrate 0.3s linear infinite;
        }

        @keyframes vibrate {
            0% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
            100% { transform: translateX(0); }
        }

        /* Settings */
        .settings {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #333;
        }

        .slider-value {
            color: #3498db;
            font-weight: bold;
            min-width: 50px;
            text-align: right;
        }

        input[type="range"] {
            width: 200px;
            height: 8px;
            -webkit-appearance: none;
            background: #333;
            border-radius: 4px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider-switch {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider-switch:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider-switch {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        input:checked + .slider-switch:before {
            transform: translateX(30px);
        }

        /* Car-specific elements */
        .car-hud {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            margin-top: 15px;
        }

        .hud-item {
            text-align: center;
        }

        .hud-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #3498db;
        }

        /* ========= DRIVER CHITCHAT PANEL ========= */
        .chat-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #333;
        }

        .chat-status {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 10px;
        }

        .chat-history {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 10px;
            font-size: 0.9rem;
        }

        .chat-message {
            margin-bottom: 8px;
        }

        .chat-message.assistant {
            color: #9b59b6;
        }

        .chat-message.driver {
            color: #1abc9c;
        }

        .chat-message strong {
            font-weight: 600;
        }

        /* Mobile responsive */
        @media (max-width: 600px) {
            h1 {
                font-size: 2rem;
            }
            
            .btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-car-crash" style="font-size: 2.5rem; color: #ff0000;"></i>
                <h1>AutoGuard AI</h1>
            </div>
            <p class="tagline">Real-time Collision Prevention System for Automotive Safety</p>
            <div class="car-hud">
                <div class="hud-item">
                    <div>Speed</div>
                    <div class="hud-value" id="speed">0 km/h</div>
                </div>
                <div class="hud-item">
                    <div>Braking</div>
                    <div class="hud-value" id="brakeStatus">OFF</div>
                </div>
                <div class="hud-item">
                    <div>System</div>
                    <div class="hud-value" id="systemStatus">READY</div>
                </div>
            </div>
        </header>

        <div class="dashboard">
            <div class="camera-container">
                <video id="camera" autoplay playsinline></video>
                <canvas id="canvas" style="display: none;"></canvas>
                
                <div class="detection-overlay">
                    <div class="hazard-zone"></div>
                </div>
                
                <div id="noCamera" style="display: none; padding: 50px; text-align: center; color: #888;">
                    <i class="fas fa-video-slash" style="font-size: 3rem;"></i>
                    <h3>Camera Not Available</h3>
                </div>
            </div>

            <div class="status-panel">
                <h3><i class="fas fa-exclamation-triangle"></i> Active Hazards <span id="hazardCount" class="severity-badge severity-low">0</span></h3>
                <div class="hazard-list" id="hazardList">
                    <div class="hazard-item safe">
                        <strong>No hazards detected</strong><br>
                        <small>System monitoring active</small>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4><i class="fas fa-chart-line"></i> Response Time</h4>
                    <div class="metric-value" id="responseTime">-- ms</div>
                </div>
            </div>
        </div>

        <div id="emergencyAlert" class="emergency-alert">
            <i class="fas fa-car-crash"></i>
            <strong>EMERGENCY: IMMINENT COLLISION DETECTED!</strong>
            <i class="fas fa-car-crash"></i>
            <div style="margin-top: 10px; font-size: 1.1rem;">
                <div>Brake immediately! Maintain safe distance!</div>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div><i class="fas fa-ruler-combined"></i> Closest Object</div>
                <div class="metric-value" id="closestDistance">-- m</div>
                <div>Distance</div>
            </div>
            <div class="metric-card">
                <div><i class="fas fa-tachometer-alt"></i> Time to Impact</div>
                <div class="metric-value metric-safe" id="timeToImpact">-- s</div>
                <div>Based on speed</div>
            </div>
            <div class="metric-card">
                <div><i class="fas fa-eye"></i> Detection Rate</div>
                <div class="metric-value" id="detectionRate">0 FPS</div>
                <div>Objects per second</div>
            </div>
            <div class="metric-card">
                <div><i class="fas fa-shield-alt"></i> Safety Score</div>
                <div class="metric-value metric-safe" id="safetyScore">100%</div>
                <div>Overall safety</div>
            </div>
        </div>

        <div class="controls">
            <button id="startBtn" class="btn btn-success">
                <i class="fas fa-play"></i> Start System
            </button>
            <button id="autoModeBtn" class="btn btn-primary">
                <i class="fas fa-robot"></i> Auto Mode
            </button>
            <button id="testAlertBtn" class="btn btn-warning">
                <i class="fas fa-bell"></i> Test Alert
            </button>
            <button id="emergencyStopBtn" class="btn btn-danger">
                <i class="fas fa-stop-circle"></i> Emergency Stop
            </button>
            <button id="calibrateBtn" class="btn">
                <i class="fas fa-cogs"></i> Calibrate
            </button>
            <!-- Driver ChitChat toggle -->
            <button id="chatToggleBtn" class="btn btn-primary">
                <i class="fas fa-headset"></i> Driver ChitChat
            </button>
        </div>

        <!-- Driver Companion / ChitChat Panel -->
        <div class="chat-panel">
            <h3><i class="fas fa-headset"></i> Driver Companion</h3>
            <div id="chatStatus" class="chat-status">
                Idle â€“ tap "Driver ChitChat" to start voice conversation with Gemini.
            </div>
            <div id="chatHistory" class="chat-history">
                <div class="chat-message assistant">
                    <strong>AutoGuard:</strong> I am ready to listen and talk to you through Gemini.
                </div>
            </div>
        </div>

        <div class="settings">
            <h3><i class="fas fa-sliders-h"></i> Safety Settings</h3>
            
            <div class="setting-item">
                <div>
                    <strong>Detection Sensitivity</strong><br>
                    <small>Adjust for different driving conditions</small>
                </div>
                <div>
                    <input type="range" id="sensitivity" min="1" max="100" value="75">
                    <span class="slider-value" id="sensitivityValue">75%</span>
                </div>
            </div>
            
            <div class="setting-item">
                <div>
                    <strong>Safe Following Distance</strong><br>
                    <small>Minimum safe distance (meters)</small>
                </div>
                <div>
                    <input type="range" id="safeDistance" min="1" max="10" step="0.5" value="3">
                    <span class="slider-value" id="distanceValue">3.0m</span>
                </div>
            </div>
            
            <div class="setting-item">
                <div>
                    <strong>Enable Audio Warnings</strong><br>
                    <small>Voice alerts for hazards</small>
                </div>
                <label class="switch">
                    <input type="checkbox" id="audioWarnings" checked>
                    <span class="slider-switch"></span>
                </label>
            </div>
            
            <div class="setting-item">
                <div>
                    <strong>Automatic Emergency Braking</strong><br>
                    <small>Simulate AEB system</small>
                </div>
                <label class="switch">
                    <input type="checkbox" id="autoBraking" checked>
                    <span class="slider-switch"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- TensorFlow.js and Models -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest"></script>
    
    <script>
        // ==================== COLLISION CONFIGURATION ====================
        const ROAD_HAZARDS = {
            'person': { severity: 'HIGH', safeDistance: 5.0 },
            'car': { severity: 'HIGH', safeDistance: 3.0 },
            'truck': { severity: 'HIGH', safeDistance: 4.0 },
            'bus': { severity: 'HIGH', safeDistance: 4.0 },
            'motorcycle': { severity: 'HIGH', safeDistance: 2.5 },
            'bicycle': { severity: 'HIGH', safeDistance: 2.0 },
            'traffic light': { severity: 'MEDIUM', safeDistance: 2.0 },
            'stop sign': { severity: 'MEDIUM', safeDistance: 2.0 },
            'parking meter': { severity: 'MEDIUM', safeDistance: 1.5 },
            'bench': { severity: 'LOW', safeDistance: 1.0 },
            'pothole': { severity: 'MEDIUM', safeDistance: 1.0 },
            'road debris': { severity: 'MEDIUM', safeDistance: 1.5 },
            'animal': { severity: 'HIGH', safeDistance: 3.0 }
        };

        // ==================== GEMINI CONFIG ====================
        const GEMINI_API_KEY = "AIzaSyDLqMY6V6ymnBJc9TZFh01ryPqU8mECGuo";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

        // State variables
        let systemActive = false;
        let detectionModel = null;
        let cameraStream = null;
        let detectionInterval = null;
        let frameCount = 0;
        let lastUpdate = Date.now();
        
        let closestObject = { distance: Infinity, type: '', confidence: 0 };
        let activeHazards = [];
        let safetyScore = 100;
        let simulatedSpeed = 0; // km/h
        let emergencyBraking = false;

        // ChitChat state
        let chitChatActive = false;
        let recognition = null;
        let chitChatInterval = null;
        let lastDriverInteraction = Date.now();
        const CHITCHAT_CHECK_INTERVAL = 45000;

        // Gemini typing effect state
        let isResponseGenerating = false;
        let typingInterval = null;

        // ==================== DOM ELEMENTS ====================
        const elements = {
            camera: document.getElementById('camera'),
            canvas: document.getElementById('canvas'),
            startBtn: document.getElementById('startBtn'),
            autoModeBtn: document.getElementById('autoModeBtn'),
            testAlertBtn: document.getElementById('testAlertBtn'),
            emergencyStopBtn: document.getElementById('emergencyStopBtn'),
            calibrateBtn: document.getElementById('calibrateBtn'),
            emergencyAlert: document.getElementById('emergencyAlert'),
            hazardCount: document.getElementById('hazardCount'),
            hazardList: document.getElementById('hazardList'),
            closestDistance: document.getElementById('closestDistance'),
            timeToImpact: document.getElementById('timeToImpact'),
            detectionRate: document.getElementById('detectionRate'),
            safetyScore: document.getElementById('safetyScore'),
            responseTime: document.getElementById('responseTime'),
            speed: document.getElementById('speed'),
            brakeStatus: document.getElementById('brakeStatus'),
            systemStatus: document.getElementById('systemStatus'),
            sensitivity: document.getElementById('sensitivity'),
            sensitivityValue: document.getElementById('sensitivityValue'),
            safeDistance: document.getElementById('safeDistance'),
            distanceValue: document.getElementById('distanceValue'),
            audioWarnings: document.getElementById('audioWarnings'),
            autoBraking: document.getElementById('autoBraking'),
            chatToggleBtn: document.getElementById('chatToggleBtn'),
            chatStatus: document.getElementById('chatStatus'),
            chatHistory: document.getElementById('chatHistory')
        };

        // ==================== GENERIC SPEECH HELPER ====================
        function speakText(text, options = {}) {
            if (!('speechSynthesis' in window)) return;
            
            const rate = options.rate || 1;
            const pitch = options.pitch || 1.1;
            const volume = options.volume || 1;
            const speech = new SpeechSynthesisUtterance();
            speech.text = text;
            speech.rate = rate;
            speech.pitch = pitch;
            speech.volume = volume;
            
            // Cancel any ongoing speech
            window.speechSynthesis.cancel();
            
            // Only speak if audio warnings are enabled OR it's a chitchat response
            if (elements.audioWarnings.checked || chitChatActive) {
                window.speechSynthesis.speak(speech);
            }
        }

        // ==================== INITIALIZATION ====================
        async function initializeSystem() {
            console.log('ðŸš— AutoGuard AI Initializing...');
            try {
                elements.systemStatus.textContent = 'LOADING AI';
                elements.systemStatus.style.color = '#f39c12';
                
                // Load TensorFlow model
                detectionModel = await cocoSsd.load({ base: 'mobilenet_v2' });
                
                console.log('âœ… AI Model loaded');
                elements.systemStatus.textContent = 'AI READY';
                elements.systemStatus.style.color = '#27ae60';
                
                elements.startBtn.disabled = false;
                elements.startBtn.innerHTML = '<i class="fas fa-play"></i> Start System';
                
                updateSettingsDisplay();
                initializeChitChatEngine();
                
                // Request camera permission early
                await requestCameraPermission();
                
            } catch (error) {
                console.error('âŒ Model loading failed:', error);
                elements.systemStatus.textContent = 'AI FAILED';
                elements.systemStatus.style.color = '#e74c3c';
                alert('AI model failed to load. Please check your internet connection.');
            }
        }

        // ==================== CAMERA PERMISSION REQUEST ====================
        async function requestCameraPermission() {
            try {
                // Just test camera access without starting stream
                const tempStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                tempStream.getTracks().forEach(track => track.stop());
                console.log('âœ… Camera permission granted');
            } catch (error) {
                console.warn('âš ï¸ Camera permission not granted yet:', error);
            }
        }

        // ==================== CAMERA SYSTEM ====================
        async function startCameraSystem() {
            if (systemActive) return;
            
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                elements.camera.srcObject = cameraStream;
                
                await new Promise(resolve => {
                    elements.camera.onloadedmetadata = () => {
                        elements.canvas.width = elements.camera.videoWidth;
                        elements.canvas.height = elements.camera.videoHeight;
                        resolve();
                    };
                });
                
                systemActive = true;
                elements.startBtn.innerHTML = '<i class="fas fa-pause"></i> Stop System';
                elements.systemStatus.textContent = 'ACTIVE';
                elements.systemStatus.style.color = '#27ae60';
                
                startDrivingSimulation();
                startDetectionLoop();
                
                console.log('âœ… Camera system activated');
            } catch (error) {
                console.error('âŒ Camera error:', error);
                alert('Camera access required for safety system. Please enable camera permissions and reload the page.');
            }
        }

        function stopCameraSystem() {
            systemActive = false;
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            elements.startBtn.innerHTML = '<i class="fas fa-play"></i> Start System';
            elements.systemStatus.textContent = 'STANDBY';
            elements.systemStatus.style.color = '#f39c12';
            clearHazardDisplay();
        }

        // ==================== DETECTION ENGINE ====================
        async function startDetectionLoop() {
            if (!systemActive) return;
            
            detectionInterval = setInterval(async () => {
                try {
                    const startTime = performance.now();
                    const ctx = elements.canvas.getContext('2d');
                    
                    // Draw camera frame to canvas
                    ctx.drawImage(elements.camera, 0, 0, elements.canvas.width, elements.canvas.height);
                    
                    // Detect objects
                    const predictions = await detectionModel.detect(elements.canvas);
                    processRoadHazards(predictions);
                    
                    const endTime = performance.now();
                    updateDetectionMetrics(endTime - startTime);
                    frameCount++;
                    
                } catch (error) {
                    console.error('Detection error:', error);
                }
            }, 100); // 10 FPS
        }

        function processRoadHazards(predictions) {
            const currentHazards = [];
            closestObject = { distance: Infinity, type: '', confidence: 0 };
            
            const sensitivity = parseInt(elements.sensitivity.value, 10) / 100;
            
            predictions.forEach(prediction => {
                const hazardType = prediction.class.toLowerCase();
                
                if (ROAD_HAZARDS[hazardType]) {
                    const hazardConfig = ROAD_HAZARDS[hazardType];
                    const confidence = prediction.score;
                    
                    // Calculate estimated distance based on bounding box size
                    const bboxArea = prediction.bbox[2] * prediction.bbox[3];
                    const canvasArea = elements.canvas.width * elements.canvas.height;
                    const distanceRatio = bboxArea / canvasArea;
                    const estimatedDistance = Math.max(0.5, 5 / Math.sqrt(distanceRatio));
                    
                    if (confidence >= (0.5 * sensitivity)) {
                        const hazard = {
                            type: hazardType,
                            confidence: Math.round(confidence * 100),
                            distance: estimatedDistance.toFixed(1),
                            severity: hazardConfig.severity,
                            safeDistance: hazardConfig.safeDistance,
                            bbox: prediction.bbox
                        };
                        currentHazards.push(hazard);
                        
                        if (estimatedDistance < closestObject.distance) {
                            closestObject = {
                                distance: estimatedDistance,
                                type: hazardType,
                                confidence: Math.round(confidence * 100)
                            };
                        }
                        
                        // Trigger emergency alert if too close
                        if (estimatedDistance < hazardConfig.safeDistance * 0.5) {
                            triggerEmergencyAlert(hazard);
                        }
                    }
                }
            });
            
            activeHazards = currentHazards;
            updateHazardDisplay();
            updateSafetyScore();
        }

        // ==================== EMERGENCY SYSTEM ====================
        function triggerEmergencyAlert(hazard) {
            if (emergencyBraking) return;
            
            emergencyBraking = true;
            
            // Show visual alert
            elements.emergencyAlert.style.display = 'block';
            document.body.classList.add('vibrate');
            
            // Update brake status
            elements.brakeStatus.textContent = 'ACTIVE';
            elements.brakeStatus.style.color = '#e74c3c';
            
            // Speak alert if audio is enabled
            if (elements.audioWarnings.checked) {
                speakEmergencyAlert(hazard);
            }
            
            // Simulate automatic braking
            if (elements.autoBraking.checked) {
                simulatedSpeed = Math.max(0, simulatedSpeed - 30);
                updateSpeedDisplay();
            }
            
            // Reset after 3 seconds
            setTimeout(() => {
                emergencyBraking = false;
                elements.emergencyAlert.style.display = 'none';
                document.body.classList.remove('vibrate');
                elements.brakeStatus.textContent = 'STANDBY';
                elements.brakeStatus.style.color = '#f39c12';
            }, 3000);
        }

        function speakEmergencyAlert(hazard) {
            const text = 'Emergency! ' + hazard.type + ' detected at ' + hazard.distance + ' meters! Brake immediately!';
            speakText(text, { rate: 0.9, pitch: 1.5, volume: 1 });
        }

        // ==================== DISPLAY UPDATES ====================
        function updateHazardDisplay() {
            const hazardCount = activeHazards.length;
            elements.hazardCount.textContent = hazardCount.toString();
            
            // Update severity badge color
            const hasHighSeverity = activeHazards.some(h => h.severity === 'HIGH');
            const hasMediumSeverity = activeHazards.some(h => h.severity === 'MEDIUM');
            
            if (hasHighSeverity) {
                elements.hazardCount.className = 'severity-badge severity-high';
            } else if (hasMediumSeverity) {
                elements.hazardCount.className = 'severity-badge severity-medium';
            } else {
                elements.hazardCount.className = 'severity-badge severity-low';
            }
            
            // Clear and update hazard list
            elements.hazardList.innerHTML = '';
            
            if (hazardCount === 0) {
                elements.hazardList.innerHTML =
                    '<div class="hazard-item safe">' +
                        '<strong>No hazards detected</strong><br>' +
                        '<small>Safe driving conditions</small>' +
                    '</div>';
                return;
            }
            
            // Sort by distance (closest first)
            activeHazards.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
            
            // Show top 5 hazards
            activeHazards.slice(0, 5).forEach(hazard => {
                const item = document.createElement('div');
                item.className = 'hazard-item ' + hazard.severity.toLowerCase();
                
                const icon = hazard.severity === 'HIGH' ? 'fa-exclamation-circle' :
                             hazard.severity === 'MEDIUM' ? 'fa-exclamation-triangle' : 'fa-info-circle';
                
                item.innerHTML =
                    '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                        '<div>' +
                            '<i class="fas ' + icon + '"></i>' +
                            '<strong>' + hazard.type.toUpperCase() + '</strong>' +
                        '</div>' +
                        '<span>' + hazard.distance + 'm</span>' +
                    '</div>' +
                    '<small>Confidence: ' + hazard.confidence + '% | Safe: ' + hazard.safeDistance + 'm</small>';
                
                elements.hazardList.appendChild(item);
            });
        }

        function clearHazardDisplay() {
            elements.hazardList.innerHTML =
                '<div class="hazard-item safe">' +
                    '<strong>System offline</strong><br>' +
                    '<small>Start system to begin detection</small>' +
                '</div>';
            
            elements.hazardCount.textContent = '0';
            elements.hazardCount.className = 'severity-badge severity-low';
            elements.closestDistance.textContent = '-- m';
            elements.timeToImpact.textContent = '-- s';
            elements.detectionRate.textContent = '0 FPS';
            elements.safetyScore.textContent = '100%';
        }

        function updateDetectionMetrics(responseTime) {
            elements.responseTime.textContent = Math.round(responseTime) + ' ms';
            
            // Update closest distance display
            if (closestObject.distance < Infinity) {
                elements.closestDistance.textContent = closestObject.distance.toFixed(1) + ' m';
                
                const safeDistance = parseFloat(elements.safeDistance.value);
                if (closestObject.distance < safeDistance * 0.5) {
                    elements.closestDistance.className = 'metric-value metric-danger';
                } else if (closestObject.distance < safeDistance) {
                    elements.closestDistance.className = 'metric-value metric-warning';
                } else {
                    elements.closestDistance.className = 'metric-value metric-safe';
                }
                
                // Calculate time to impact
                if (simulatedSpeed > 0) {
                    const speedMps = simulatedSpeed / 3.6;
                    const tti = closestObject.distance / speedMps;
                    elements.timeToImpact.textContent = tti.toFixed(1) + ' s';
                    
                    if (tti < 2) {
                        elements.timeToImpact.className = 'metric-value metric-danger';
                    } else if (tti < 5) {
                        elements.timeToImpact.className = 'metric-value metric-warning';
                    } else {
                        elements.timeToImpact.className = 'metric-value metric-safe';
                    }
                }
            }
            
            // Update FPS counter every second
            const now = Date.now();
            if (now - lastUpdate > 1000) {
                const fps = Math.round((frameCount * 1000) / (now - lastUpdate));
                elements.detectionRate.textContent = fps + ' FPS';
                frameCount = 0;
                lastUpdate = now;
            }
        }

        function updateSafetyScore() {
            let score = 100;
            activeHazards.forEach(hazard => {
                const distanceRatio = parseFloat(hazard.distance) / hazard.safeDistance;
                if (distanceRatio < 0.5) {
                    score -= 30;
                } else if (distanceRatio < 1) {
                    score -= 15;
                } else if (distanceRatio < 2) {
                    score -= 5;
                }
            });
            score = Math.max(0, Math.min(100, score));
            safetyScore = score;
            elements.safetyScore.textContent = score + '%';
            
            // Update safety score color
            if (score >= 80) {
                elements.safetyScore.className = 'metric-value metric-safe';
            } else if (score >= 60) {
                elements.safetyScore.className = 'metric-value metric-warning';
            } else {
                elements.safetyScore.className = 'metric-value metric-danger';
            }
        }

        // ==================== DRIVING SIMULATION ====================
        function startDrivingSimulation() {
            setInterval(() => {
                if (systemActive && !emergencyBraking) {
                    // Random speed fluctuation
                    const speedChange = Math.random() * 10 - 5;
                    simulatedSpeed = Math.max(0, Math.min(120, simulatedSpeed + speedChange));
                    
                    // Slow down if too close to hazard
                    if (closestObject.distance < parseFloat(elements.safeDistance.value)) {
                        simulatedSpeed = Math.max(0, simulatedSpeed - Math.random() * 5);
                    }
                    updateSpeedDisplay();
                }
            }, 1000);
        }

        function updateSpeedDisplay() {
            elements.speed.textContent = Math.round(simulatedSpeed) + ' km/h';
            
            // Color code speed based on safety
            if (closestObject.distance < Infinity) {
                const safeDistance = parseFloat(elements.safeDistance.value);
                const relativeSpeed = simulatedSpeed / 50;
                
                if (closestObject.distance < safeDistance && relativeSpeed > 0.8) {
                    elements.speed.style.color = '#e74c3c';
                } else if (closestObject.distance < safeDistance * 2) {
                    elements.speed.style.color = '#f39c12';
                } else {
                    elements.speed.style.color = '#27ae60';
                }
            }
        }

        // ==================== SETTINGS ====================
        function updateSettingsDisplay() {
            // Sensitivity slider
            elements.sensitivityValue.textContent = elements.sensitivity.value + '%';
            elements.sensitivity.addEventListener('input', () => {
                elements.sensitivityValue.textContent = elements.sensitivity.value + '%';
            });
            
            // Safe distance slider
            elements.distanceValue.textContent = elements.safeDistance.value + 'm';
            elements.safeDistance.addEventListener('input', () => {
                elements.distanceValue.textContent = elements.safeDistance.value + 'm';
            });
        }

        // ==================== DRIVER CHITCHAT + GEMINI ====================
        function appendChatMessage(role, text) {
            const div = document.createElement('div');
            div.className = 'chat-message ' + role;
            const label = role === 'assistant' ? 'AutoGuard' : 'Driver';
            div.innerHTML = '<strong>' + label + ':</strong> <span class="text"></span>';
            div.querySelector('.text').textContent = text;
            elements.chatHistory.appendChild(div);
            elements.chatHistory.scrollTop = elements.chatHistory.scrollHeight;
            return div;
        }

        function showTypingEffect(text, textElement, onComplete) {
            const words = text.split(' ');
            let currentWordIndex = 0;

            clearInterval(typingInterval);
            typingInterval = setInterval(() => {
                if (!isResponseGenerating || currentWordIndex >= words.length) {
                    clearInterval(typingInterval);
                    isResponseGenerating = false;
                    if (onComplete) onComplete();
                    return;
                }

                textElement.innerText += (currentWordIndex === 0 ? '' : ' ') + words[currentWordIndex++];
                elements.chatHistory.scrollTo(0, elements.chatHistory.scrollHeight);
            }, 75);
        }

        async function callGeminiAPI(messageText) {
            if (!messageText || isResponseGenerating) return;

            isResponseGenerating = true;
            elements.chatStatus.textContent = 'Talking to Gemini...';

            // Create assistant message shell
            const msgDiv = appendChatMessage('assistant', '');
            const textElement = msgDiv.querySelector('.text');
            textElement.innerText = '';

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        contents: [{
                            role: "user",
                            parts: [{ text: messageText }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 500,
                        }
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'Gemini API error');
                }

                const apiResponse = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'No response from assistant.';
                const cleaned = apiResponse.replace(/\\(.?)\\*/g, '$1');

                // Show typing effect and speak response
                showTypingEffect(cleaned, textElement, () => {
                    speakText(cleaned, { rate: 1, pitch: 1.05 });
                    elements.chatStatus.textContent = 'Listening... Say something when you are ready.';
                });
                
            } catch (error) {
                console.error('Gemini API Error:', error);
                isResponseGenerating = false;
                textElement.innerText = 'Sorry, I encountered an error: ' + (error.message || 'Please try again.');
                elements.chatStatus.textContent = 'Error. You may try speaking again.';
            }
        }

        function initializeChitChatEngine() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                elements.chatStatus.textContent = "Voice assistant not supported in this browser. Use a modern Chrome-based browser.";
                elements.chatToggleBtn.disabled = true;
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onresult = (event) => {
                const lastResult = event.results[event.results.length - 1];
                if (!lastResult.isFinal) return;
                
                const text = lastResult[0].transcript.trim();
                if (text.length > 0) {
                    lastDriverInteraction = Date.now();
                    handleDriverUtterance(text);
                }
            };

            recognition.onerror = (event) => {
                console.warn('Speech recognition error:', event.error);
                if (chitChatActive) {
                    elements.chatStatus.textContent = "Voice connection interrupted. Tap 'Driver ChitChat' again if needed.";
                }
            };

            recognition.onend = () => {
                if (chitChatActive) {
                    try { 
                        recognition.start(); 
                    } catch (e) { 
                        console.warn('Restart recognition failed:', e);
                        setTimeout(() => {
                            if (chitChatActive) {
                                try { recognition.start(); } catch (err) { console.error('Failed to restart:', err); }
                            }
                        }, 1000);
                    }
                }
            };

            elements.chatStatus.textContent = "Driver Companion is available. Tap 'Driver ChitChat' to start.";
        }

        function startChitChat() {
            if (!recognition) return;

            chitChatActive = true;
            lastDriverInteraction = Date.now();
            
            // Update UI
            elements.chatToggleBtn.classList.remove('btn-primary');
            elements.chatToggleBtn.classList.add('btn-success');
            elements.chatToggleBtn.innerHTML = '<i class="fas fa-headset"></i> ChitChat ON';
            elements.chatStatus.textContent = "Listening... Speak and Gemini will answer.";
            
            // Add initial message
            appendChatMessage('assistant', "I'm listening now. You can talk to me about driving, safety, or anything else.");

            try { 
                recognition.start(); 
            } catch (e) { 
                console.warn('Recognition start error:', e);
                elements.chatStatus.textContent = "Please allow microphone access to use voice chat.";
            }

            // Periodic check-in if no interaction
            if (chitChatInterval) clearInterval(chitChatInterval);
            chitChatInterval = setInterval(() => {
                const now = Date.now();
                if (chitChatActive && (now - lastDriverInteraction > CHITCHAT_CHECK_INTERVAL)) {
                    appendChatMessage('assistant', 'Still here with you. You can talk to me anytime.');
                    lastDriverInteraction = Date.now();
                }
            }, CHITCHAT_CHECK_INTERVAL);
        }

        function stopChitChat() {
            chitChatActive = false;
            
            if (recognition) {
                try { 
                    recognition.stop(); 
                } catch (e) { 
                    console.warn('Recognition stop error:', e);
                }
            }
            
            if (chitChatInterval) {
                clearInterval(chitChatInterval);
                chitChatInterval = null;
            }
            
            // Update UI
            elements.chatToggleBtn.classList.remove('btn-success');
            elements.chatToggleBtn.classList.add('btn-primary');
            elements.chatToggleBtn.innerHTML = '<i class="fas fa-headset"></i> Driver ChitChat';
            elements.chatStatus.textContent = "ChitChat is off. Tap the button to start again.";
            
            appendChatMessage('assistant', "I will be quiet now, but I am ready when you are.");
        }

        function handleDriverUtterance(text) {
            console.log('Driver said:', text);
            
            // Add driver message to chat
            appendChatMessage('driver', text);
            elements.chatStatus.textContent = 'Recognised: "' + text + '". Sending to Gemini...';
            
            // Send to Gemini
            callGeminiAPI(text);
        }

        // ==================== EVENT LISTENERS ====================
        elements.startBtn.addEventListener('click', () => {
            if (!systemActive) {
                startCameraSystem();
            } else {
                stopCameraSystem();
            }
        });

        elements.autoModeBtn.addEventListener('click', () => {
            const isAutoMode = elements.autoModeBtn.classList.contains('btn-success');
            
            if (isAutoMode) {
                elements.autoModeBtn.classList.remove('btn-success');
                elements.autoModeBtn.classList.add('btn-primary');
                elements.autoModeBtn.innerHTML = '<i class="fas fa-robot"></i> Auto Mode OFF';
            } else {
                elements.autoModeBtn.classList.remove('btn-primary');
                elements.autoModeBtn.classList.add('btn-success');
                elements.autoModeBtn.innerHTML = '<i class="fas fa-robot"></i> Auto Mode ON';
            }
        });

        elements.testAlertBtn.addEventListener('click', () => {
            triggerEmergencyAlert({
                type: 'test vehicle',
                distance: '1.5',
                severity: 'HIGH'
            });
        });

        elements.emergencyStopBtn.addEventListener('click', () => {
            stopCameraSystem();
            simulatedSpeed = 0;
            updateSpeedDisplay();
            alert('Emergency stop activated. System halted.');
        });

        elements.calibrateBtn.addEventListener('click', () => {
            alert('Calibration mode activated. Please ensure clear view of road ahead.');
        });

        elements.chatToggleBtn.addEventListener('click', () => {
            if (!chitChatActive) {
                startChitChat();
            } else {
                stopChitChat();
            }
        });

        // ==================== INITIALIZE ====================
        window.addEventListener('load', initializeSystem);

        console.log('ðŸš— AutoGuard AI Safety System Loaded');
        console.log('Features: Camera collision detection + Gemini voice chitchat');
    </script>
</body>
</html>